
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Presenter Server · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters-theme.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-copy/css/copy.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="presenter-agent.html" />
    
    
    <link rel="prev" href="presenter.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="overview.html">
            
                <a href="overview.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="environment-preparation.html">
            
                <a href="environment-preparation.html">
            
                    
                    Environment Preparation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="prerequisites.html">
            
                <a href="prerequisites.html">
            
                    
                    Prerequisites
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="software-preparation.html">
            
                <a href="software-preparation.html">
            
                    
                    Software Preparation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="face-detection-sample.html">
            
                <a href="face-detection-sample.html">
            
                    
                    Face Detection Sample
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="ascendcamera.html">
            
                <a href="ascendcamera.html">
            
                    
                    Ascendcamera
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="principle.html">
            
                <a href="principle.html">
            
                    
                    Principle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="deployment.html">
            
                <a href="deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="running.html">
            
                <a href="running.html">
            
                    
                    Running
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.1" data-path="saving-media-information-offline.html">
            
                <a href="saving-media-information-offline.html">
            
                    
                    Saving Media Information Offline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.2" data-path="viewing-media-information-in-real-time.html">
            
                <a href="viewing-media-information-in-real-time.html">
            
                    
                    Viewing Media Information in Real Time
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.2.1" data-path="playing-a-real-time-video-through-presenter-server.html">
            
                <a href="playing-a-real-time-video-through-presenter-server.html">
            
                    
                    Playing a Real-Time Video Through Presenter Server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.2.2" data-path="playing-a-real-time-video-through-vlc.html">
            
                <a href="playing-a-real-time-video-through-vlc.html">
            
                    
                    Playing a Real-Time Video Through VLC
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="facial-recognition-sample.html">
            
                <a href="facial-recognition-sample.html">
            
                    
                    Facial Recognition Sample
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="principle-0.html">
            
                <a href="principle-0.html">
            
                    
                    Principle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="deployment-1.html">
            
                <a href="deployment-1.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="running-2.html">
            
                <a href="running-2.html">
            
                    
                    Running
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="video-analysis-sample.html">
            
                <a href="video-analysis-sample.html">
            
                    
                    Video Analysis Sample
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="principle-3.html">
            
                <a href="principle-3.html">
            
                    
                    Principle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="deployment-4.html">
            
                <a href="deployment-4.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="running-5.html">
            
                <a href="running-5.html">
            
                    
                    Running
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="network-connectivity.html">
            
                <a href="network-connectivity.html">
            
                    
                    Network Connectivity
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="principle-6.html">
            
                <a href="principle-6.html">
            
                    
                    Principle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="deployment-7.html">
            
                <a href="deployment-7.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="running-8.html">
            
                <a href="running-8.html">
            
                    
                    Running
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="（advanced）-source-code-analysis-for-common-modules.html">
            
                <a href="（advanced）-source-code-analysis-for-common-modules.html">
            
                    
                    （Advanced） Source Code Analysis for Common Modules
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="presenter.html">
            
                <a href="presenter.html">
            
                    
                    Presenter
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.9.1.1" data-path="presenter-server.html">
            
                <a href="presenter-server.html">
            
                    
                    Presenter Server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.2" data-path="presenter-agent.html">
            
                <a href="presenter-agent.html">
            
                    
                    Presenter Agent
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="ezdvpp.html">
            
                <a href="ezdvpp.html">
            
                    
                    EZDVPP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="appendix.html">
            
                <a href="appendix.html">
            
                    
                    Appendix
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="downloading-network-models.html">
            
                <a href="downloading-network-models.html">
            
                    
                    Downloading Network Models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="viewing-the-channel-to-which-a-camera-belongs.html">
            
                <a href="viewing-the-channel-to-which-a-camera-belongs.html">
            
                    
                    Viewing the Channel to Which a Camera Belongs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="how-do-i-upload-files-to-the-host.html">
            
                <a href="how-do-i-upload-files-to-the-host.html">
            
                    
                    How Do I Upload Files to the Host?
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="disclaimer.html">
            
                <a href="disclaimer.html">
            
                    
                    Disclaimer
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Presenter Server</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="presenter-server">Presenter Server<a id="EN-US_TOPIC_0167289971"></a></h1>
<h2 id="description">Description<a id="section41283618519"></a></h2>
<p>Presenter Server is a software package that displays the result of face detection and inference. It is implemented based on Python 3.5 and uses the third-party web framework Tornado and underlying communication framework protobuf.</p>
<p>Presenter Server supports the image mode and video mode. In image mode, the image contains a single face. In video mode, consecutive images are displayed. Presenter Server marks different data sources based on channels. You can click  <strong>Create</strong>  in the browser to add channels and click<strong> Delete </strong>to delete channels. By default, two channels are supported, namely, image and video.</p>
<h2 id="sample-code">Sample Code<a id="section3697333103110"></a></h2>
<p>The root directory of Presenter Server is  <strong>common/presenter/server</strong>.  <strong>face_detection</strong>  is the directory of the face detection application.  <strong>config</strong>  is the directory for configuration files. You can modify<strong> config.conf </strong>to customize the server IP address and port.<strong> logging.conf</strong>  is the configuration of the logging module.  <strong>src</strong>  is the source code directory.  <strong>presenter_message_pb2.py </strong>defines the protobuf format.  <strong>presenter_socket_server.py</strong>  is responsible for receiving facial data in parallel.  <strong>webapp.py</strong>  is responsible for pushing data to Chrome for display on the GUI.  <strong>ui</strong>  is the directory where the GUI materials for the Web pages are located.</p>
<p>Message communication with Presenter Agent:</p>
<p>The following figure shows the message communication between Presenter Server, Presenter Agent, and Chrome. Chrome initiates a channel creation operation. Presenter Server sends facial data to a specified channel. Chrome opens the channel and checks the face detection result.</p>
<p><img src="figures/en-us_image_0167289912.png" alt=""></p>
<p>The structure of the message between Presenter Server and Presenter Agent contains the following information: total message length &#xFF08;4 bytes&#xFF09;, message name length &#xFF08;1 byte&#xFF09;, message name &#xFF08;XX bytes&#xFF09;, and the protobuf content &#xFF08;XX bytes&#xFF09;.</p>
<pre><code>--------------------------------------------------------------
|total message len      |    int             |    4 bytes                  |
|--------------------------------------------------------------
|message name len    |    byte           |    1 byte                   |
|--------------------------------------------------------------
|message name          |    string         |    xx bytes                |
|--------------------------------------------------------------
|message body           |    protobuf    |    xx bytes                |
---------------------------------------------------------------
</code></pre><p>There are two main messages. One is the message for opening channels &#xFF08;OpenChannelRequest&#xFF09;, and the other is the message for sending facial data &#xFF08;PresentImageRequest&#xFF09;. The syntax in the protobuf is as follows:</p>
<pre><code>message OpenChannelRequest {
string channel_name = 1; // Channel name
ChannelContentType content_type = 2; // Data mode, used to identify whether the channel is image or video
}

message PresentImageRequest {
ImageFormat format = 1; // Image format. Currently, only JPEG is supported.
uint32 width = 2; // Image width
uint32 height =3; // Image height
bytes data = 4; // Image data
}
</code></pre><p>The epoll API implements parallel working of multiple channels. The implementation pseudo code is as follows:</p>
<pre><code>def _server_listen_thread(self):
&quot;&quot;&quot;socket server thread, epoll listening all the socket events&quot;&quot;&quot;
epoll = select.epoll()
epoll.register(self._sock_server.fileno(), select.EPOLLIN | select.EPOLLHUP)
try:
conns = {}
msgs = {}
while True:
events = epoll.poll(EPOLL_TIMEOUT)
# timeout, but no event come, continue waiting
if not events:
continue
for sock_fileno, event in events:
# new connection request from presenter agent
if self._sock_server.fileno() == sock_fileno:
self._accept_new_socket(epoll, conns)
# remote connection closed
# it means presenter agent exit withot close socket.
elif event &amp; select.EPOLLHUP:
self._clean_connect(sock_fileno, epoll, conns, msgs)
# new data coming in a socket connection
elif event &amp; select.EPOLLIN:
self._process_epollin(sock_fileno, epoll, conns, msgs)
# receive event not recognize
else:
self._clean_connect(sock_fileno, epoll, conns, msgs)
finally:
epoll.unregister(self._sock_server.fileno())
epoll.close()
self._sock_server.close()
</code></pre><p>In the message parsing process, the implementation pseudo code is as follows. First, the message is parsed, including the message length and message name, and finally the protobuf is read for processing.</p>
<pre><code>def _read_sock_and_process_msg(self, sock_fileno, conns, msgs):
# Step1: read msg head
msg_total_len, msg_name_len = self._read_msg_head(sock_fileno, conns)
if msg_total_len is None:
return PRESENTER_ERR
# Step2: read msg name
msg_name = self._read_msg_name(conns[sock_fileno], msg_name_len)
if msg_name == SOCKET_RECEIVE_NULL:
return PRESENTER_ERR
try:
msg_name = msg_name.decode(&quot;utf-8&quot;)
except UnicodeDecodeError:
return PRESENTER_ERR
# Step3:  read msg body
msg_body_len = msg_total_len - MSG_HEAD_LENGTH - msg_name_len
ret = self._read_msg_body(sock_fileno, conns, msgs, msg_name, msg_body_len)
if ret == PRESENTER_ERR:
return ret
# Step4: process msg
ret = self._process_msg(conns[sock_fileno], msg_name, msgs[sock_fileno])
return ret
</code></pre><p>In the protobuf parsing process, there are three message requests from Presenter Agent, used for opening channels, sending facial data, and sending heartbeat messages, respectively.</p>
<pre><code>def _process_msg(self, conn, msg_name, msg_data):
# process open channel request
if msg_name == OPEN_CHANNEL_REQUEST_FULL_NAME:
ret = self._process_open_channel(conn, msg_data)
# process image request, receive an image data from presenter agent
elif msg_name == PRESENT_IMAGE_REQUEST_FULL_NAME:
ret = self._process_image_request(conn, msg_data)
# process heartbeat request, it used to keepalive a channel path
elif msg_name == HEART_BEAT_MESSAGE_FULL_NAME:
ret = self._process_heartbeat(conn)
else:
ret = PRESENTER_ERR
return ret
</code></pre>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="presenter.html" class="navigation navigation-prev " aria-label="Previous page: Presenter">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="presenter-agent.html" class="navigation navigation-next " aria-label="Next page: Presenter Agent">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Presenter Server","level":"1.9.1.1","depth":3,"next":{"title":"Presenter Agent","level":"1.9.1.2","depth":3,"path":"presenter-agent.md","ref":"presenter-agent.md","articles":[]},"previous":{"title":"Presenter","level":"1.9.1","depth":2,"path":"presenter.md","ref":"presenter.md","articles":[{"title":"Presenter Server","level":"1.9.1.1","depth":3,"path":"presenter-server.md","ref":"presenter-server.md","articles":[]},{"title":"Presenter Agent","level":"1.9.1.2","depth":3,"path":"presenter-agent.md","ref":"presenter-agent.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{"imgUrl":"","topnav":[]},"plugins":["expandable-chapters","copy"],"pluginsConfig":{"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"copy":{},"expandableChapters":{"cssFile":["expandable-chapters-theme.css"]},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"website.css"}},"file":{"path":"presenter-server.md","mtime":"2019-04-26T08:02:08.092Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-04-26T08:02:12.360Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-copy/js/clipboard.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-copy/js/copy.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

